#!/usr/bin/env bash

: << !
Name: usb-manager
Author: YJ
Email: yj1516268@outlook.com
Created Time: 2023-03-22 15:58:15

Description: 使用udisk2控制可移动USB存储设备

Attentions:
-

Depends:
- udisk2
- jq
!

####################################################################
#+++++++++++++++++++++++++ Define Variable ++++++++++++++++++++++++#
####################################################################
#------------------------- Program Variable
# program name
name=$(basename "$0")
readonly name
# program version
readonly major_version=0.3.1
readonly minor_version=20230323
readonly rel_version=3

#------------------------- Exit Code Variable
readonly err_file=1         # 文件/路径类错误
readonly err_no_program=127 # 未找到命令
readonly err_unknown=255    # 未知错误

#------------------------- Parameter Variable
# description variable
readonly desc="用于控制可移动USB存储设备"

####################################################################
#+++++++++++++++++++++++++ Define Function ++++++++++++++++++++++++#
####################################################################
#------------------------- Info Function
function helpInfo() {
  echo -e ""
  echo -e "\033[32m$name\033[0m\033[1m$desc\033[0m"
  echo -e "--------------------------------------------------"
  echo -e "Usage:"
  echo -e ""
  echo -e "     $name [OPTION]"
  echo -e ""
  echo -e "Options:"
  echo -e "     -l, --list                                列出USB存储设备"
  echo -e "     -m, --mount   [all, PartName, DiskName]   挂载USB存储设备"
  echo -e "     -u, --unmount [all, PartName, DiskName]   卸载USB存储设备（仅卸载）"
  echo -e "     -r, --remove  [all, DiskName]             弹出USB存储设备（卸载并弹出）"
  echo -e ""
  echo -e "     -h, --help                                显示帮助信息"
  echo -e "     -v, --version                             显示版本信息"
  echo -e ""
  echo -e "Args:"
  echo -e "     all     : 所有可移动USB存储设备"
  echo -e "     PartName: 指定的可移动USB存储设备分区"
  echo -e "     DiskName: 指定的可移动USB存储设备"
}

function versionInfo() {
  echo -e ""
  echo -e "\033[1m$name\033[0m version (\033[1m$major_version-$minor_version.$rel_version\033[0m)"
}

#------------------------- Feature Function
function checkCommand() {
  if ! command -v "$1" &> /dev/null; then
    echo -e "$1 未安装"
    exit $err_no_program
  fi
}

function listAction() { # 列出设备
  # 罗列可移动USB存储设备的名字(NAME)、类型(TYPE)、是否可卸载(RM)和挂载点(MOUNTPOINT)
  devices=$(lsblk -Jplno NAME,TYPE,RM,MOUNTPOINT)
  # 使用jq查找符合要求的设备并转为数组存储（IFS=" "指定使用空格作为分隔符）
  IFS=" " read -r -a partnames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | .name' | tr '\n' ' ')"
  IFS=" " read -r -a mountpoints <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | .mountpoint' | tr '\n' ' ')"

  for ((index = 0; index < ${#partnames[*]}; index++)); do
    if [ "${mountpoints[index]}" == 'null' ]; then
      echo -e "${partnames[index]} is not mounted"
    else
      echo -e "${partnames[index]} is mounted to ${mountpoints[index]}"
    fi
  done
}

function mountAction() { # 挂载设备
  # 罗列可移动USB存储设备的名字(NAME)、类型(TYPE)、是否可卸载(RM)和挂载点(MOUNTPOINT)
  devices=$(lsblk -Jplno NAME,TYPE,RM,MOUNTPOINT)
  # 使用jq查找符合要求的设备
  IFS=" " read -r -a disknames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "disk") | select(.rm == true) | .name' | tr '\n' ' ')"
  IFS=" " read -r -a partnames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | select(.mountpoint == null) | .name' | tr '\n' ' ')"

  if [[ "$1" == 'all' ]]; then
    # --mount 的参数是'all'，挂载所有part
    for ((index = 0; index < ${#partnames[*]}; index++)); do
      udisksctl mount --no-user-interaction -b "${partnames[index]}"
    done
  elif [ -b "$1" ]; then # 检测是否是块设备
    if [[ "${disknames[*]}" =~ $1 ]]; then
      # --mount 的参数是disk，挂载该disk的所有part
      IFS=" " read -r -a disk_parts <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | select(.mountpoint == null) | .[] | scan("'"$1"'.*")?' | tr '\n' ' ')"
      for ((index = 0; index < ${#disk_parts[*]}; index++)); do
        udisksctl mount --no-user-interaction -b "${disk_parts[index]}"
      done
    else
      # --mount 的参数是part，挂载该part
      udisksctl mount --no-user-interaction -b "$1"
    fi
  else
    echo "$1 不是可移动USB存储设备"
    exit $err_file
  fi
}

function unmountAction() { # 卸载设备
  # 罗列可移动USB存储设备的名字(NAME)、类型(TYPE)、是否可卸载(RM)和挂载点(MOUNTPOINT)
  devices=$(lsblk -Jplno NAME,TYPE,RM,MOUNTPOINT)
  # 使用jq查找符合要求的设备
  IFS=" " read -r -a disknames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "disk") | select(.rm == true) | .name' | tr '\n' ' ')"
  IFS=" " read -r -a partnames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | select(.mountpoint != null) | .name' | tr '\n' ' ')"

  if [[ "$1" == 'all' ]]; then
    # --unmount 的参数是'all'，卸载所有part
    for ((index = 0; index < ${#partnames[*]}; index++)); do
      udisksctl unmount --no-user-interaction -b "${partnames[index]}"
    done
  elif [ -b "$1" ]; then # 检测是否是块设备
    if [[ "${disknames[*]}" =~ $1 ]]; then
      # --unmount 的参数是disk，卸载该disk的所有part
      IFS=" " read -r -a disk_parts <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | select(.mountpoint != null) | .[] | scan("'"$1"'.*")?' | tr '\n' ' ')"
      for ((index = 0; index < ${#disk_parts[*]}; index++)); do
        udisksctl unmount --no-user-interaction -b "${disk_parts[index]}"
      done
    else
      # --unmount 的参数是part，卸载该part
      udisksctl unmount --no-user-interaction -b "$1"
    fi
  else
    echo "$1 不是可移动USB存储设备"
    exit $err_file
  fi
}

function removeAction() { # 移除设备
  # 罗列可移动USB存储设备的名字(NAME)、类型(TYPE)、是否可卸载(RM)和挂载点(MOUNTPOINT)
  devices=$(lsblk -Jplno NAME,TYPE,RM,MOUNTPOINT)
  # 使用jq查找符合要求的设备
  IFS=" " read -r -a disknames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "disk") | select(.rm == true) | .name' | tr '\n' ' ')"
  IFS=" " read -r -a partnames <<< "$(echo "$devices" | jq -r '.blockdevices[] | select(.type == "part") | select(.rm == true) | select(.mountpoint != null) | .name' | tr '\n' ' ')"

  # 卸载设备
  unmountAction "$1"

  if [[ "$1" == 'all' ]]; then
    # 移除设备
    for ((index = 0; index < ${#disknames[*]}; index++)); do
      udisksctl power-off --no-user-interaction -b "${disknames[index]}"
      echo -e "${disknames[index]} is safely removed"
    done
  elif [ -b "$1" ]; then # 检测是否是块设备
    if [[ "${disknames[*]}" =~ $1 ]]; then
      udisksctl power-off --no-user-interaction -b "$1"
      echo -e "$1 is safely removed"
    fi
  else
    echo "$1 不是可移动USB存储设备"
    exit $err_file
  fi
}

####################################################################
#++++++++++++++++++++++++++++++ Main ++++++++++++++++++++++++++++++#
####################################################################
ARGS=$(getopt --options "lm:u:r:hv" --longoptions "list,mount:,unmount:,remove:,help,version" -n "$name" -- "$@")
eval set -- "$ARGS"

if [[ ${#@} -lt 2 ]]; then
  checkCommand "udisksctl"
  listAction
else
  while true; do
    case $1 in
      -l | --list)
        checkCommand "udisksctl"
        listAction
        shift 1
        ;;
      -m | --mount)
        checkCommand "udisksctl"
        mountAction "$2"
        shift 2
        ;;
      -u | --unmount)
        checkCommand "udisksctl"
        unmountAction "$2"
        shift 2
        ;;
      -r | --remove)
        checkCommand "udisksctl"
        removeAction "$2"
        shift 2
        ;;
      -h | --help)
        helpInfo
        shift 1
        ;;
      -v | --version)
        versionInfo
        shift 1
        ;;
      --)
        shift 1
        break
        ;;
      *)
        helpInfo
        exit $err_unknown
        ;;
    esac
  done
fi
